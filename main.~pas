unit main;

interface

uses
  Windows, Messages, SysUtils, Classes, Graphics, Controls, Forms, Dialogs,
  Menus, StdCtrls, Buttons, ScktComp, ExtCtrls, ComCtrls, ImgList,
  abfComponents, ToolWin;

type
  TChatForm = class(TForm)
    MainMenu1: TMainMenu;
    File1: TMenuItem;
    Exit1: TMenuItem;
    FileConnectItem: TMenuItem;
    FileListenItem: TMenuItem;
    StatusBar1: TStatusBar;
    Bevel1: TBevel;
    Memo1: TMemo;
    Memo2: TMemo;
    N1: TMenuItem;
    Disconnect1: TMenuItem;
    ServerSocket: TServerSocket;
    ClientSocket: TClientSocket;
    ColorDialog1: TColorDialog;
    FontDialog1: TFontDialog;
    ImageList1: TImageList;
    ImageList2: TImageList;
    abfTrayIcon1: TabfTrayIcon;
    Editar1: TMenuItem;
    Recortar1: TMenuItem;
    Copiar1: TMenuItem;
    Colar1: TMenuItem;
    N2: TMenuItem;
    DefinirFonte1: TMenuItem;
    DefinirFundo1: TMenuItem;
    N3: TMenuItem;
    SelecionarTudo1: TMenuItem;
    Ajuda1: TMenuItem;
    MessageWav: TabfWav;
    ClickWav: TabfWav;
    ErrorWav: TabfWav;
    ImageList3: TImageList;
    ToolBar1: TToolBar;
    SpeedButton1: TSpeedButton;
    SpeedButton2: TSpeedButton;
    SpeedButton3: TSpeedButton;
    SpeedButton4: TSpeedButton;
    SpeedButton5: TSpeedButton;
    SpeedButton6: TSpeedButton;
    CheckBox1: TCheckBox;
    ToolButton1: TToolButton;
    ToolButton2: TToolButton;
    Panel1: TPanel;
    PopupMenu1: TPopupMenu;
    Maximizar1: TMenuItem;
    Minimizar1: TMenuItem;
    N4: TMenuItem;
    Sair1: TMenuItem;
    N5: TMenuItem;
    Desconectar1: TMenuItem;
    Panel2: TPanel;
    procedure FileListenItemClick(Sender: TObject);
    procedure FileConnectItemClick(Sender: TObject);
    procedure Exit1Click(Sender: TObject);
    procedure Memo1KeyDown(Sender: TObject; var Key: Word;
      Shift: TShiftState);
    procedure FormCreate(Sender: TObject);
    procedure ServerSocketError(Sender: TObject; Number: Smallint;
      var Description: string; Scode: Integer; const Source,
      HelpFile: string; HelpContext: Integer; var CancelDisplay: Wordbool);
    procedure Disconnect1Click(Sender: TObject);
    procedure ClientSocketConnect(Sender: TObject;
      Socket: TCustomWinSocket);
    procedure ClientSocketRead(Sender: TObject; Socket: TCustomWinSocket);
    procedure ServerSocketClientRead(Sender: TObject;
      Socket: TCustomWinSocket);
    procedure ServerSocketAccept(Sender: TObject;
      Socket: TCustomWinSocket);
    procedure ServerSocketClientConnect(Sender: TObject;
      Socket: TCustomWinSocket);
    procedure ClientSocketDisconnect(Sender: TObject;
      Socket: TCustomWinSocket);
    procedure ClientSocketError(Sender: TObject; Socket: TCustomWinSocket;
      ErrorEvent: TErrorEvent; var ErrorCode: Integer);
    procedure ServerSocketClientDisconnect(Sender: TObject;
      Socket: TCustomWinSocket);
    procedure SpeedButton3Click(Sender: TObject);
    procedure SpeedButton4Click(Sender: TObject);
    procedure SpeedButton5Click(Sender: TObject);
    procedure SpeedButton6Click(Sender: TObject);
    procedure SpeedButton2Click(Sender: TObject);
    procedure Memo1Click(Sender: TObject);
    procedure Memo2Click(Sender: TObject);
    procedure abfTrayIcon1DblClick(Sender: TObject);
    procedure Recortar1Click(Sender: TObject);
    procedure Copiar1Click(Sender: TObject);
    procedure Colar1Click(Sender: TObject);
    procedure DefinirFonte1Click(Sender: TObject);
    procedure DefinirFundo1Click(Sender: TObject);
    procedure SelecionarTudo1Click(Sender: TObject);
    procedure ToolBar1Click(Sender: TObject);
    procedure ToolButton1Click(Sender: TObject);
    procedure Minimizar1Click(Sender: TObject);
    procedure Maximizar1Click(Sender: TObject);
    procedure Sair1Click(Sender: TObject);
    procedure Desconectar1Click(Sender: TObject);
    procedure Ajuda1Click(Sender: TObject);
  protected
    IsServer: Boolean;
  end;

var
  ChatForm: TChatForm;
  Server: String;

  Texto: string;

implementation

uses Unit1;

{$R *.dfm}

procedure TChatForm.FileListenItemClick(Sender: TObject);
begin
  FileListenItem.Checked := not FileListenItem.Checked;
  if FileListenItem.Checked then
  begin
    ClientSocket.Active := False;
    ServerSocket.Active := True;
    Statusbar1.Panels[0].Text := 'Esperando conexão...';
  end
  else
  begin
    if ServerSocket.Active then
      ServerSocket.Active := False;
    Statusbar1.Panels[0].Text := '';
  end;
end;

procedure TChatForm.FileConnectItemClick(Sender: TObject);
begin
  if ClientSocket.Active then ClientSocket.Active := False;
  if InputQuery('Estabelecer Conexão', 'Endereço IP da rede:', Server) then
    if Length(Server) > 0 then
      with ClientSocket do
      begin
        Host := Server;
        Active := True;
        FileListenItem.Checked := False;
      end;
end;

procedure TChatForm.Exit1Click(Sender: TObject);
begin
  ServerSocket.Close;
  ClientSocket.Close;
  Close;
end;

procedure TChatForm.Memo1KeyDown(Sender: TObject; var Key: Word;
  Shift: TShiftState);
begin
  if Key = VK_Return then
    if IsServer then
      ServerSocket.Socket.Connections[0].SendText(Memo1.Lines[Memo1.Lines.Count - 1])
    else
      ClientSocket.Socket.SendText(Memo1.Lines[Memo1.Lines.Count - 1]);

    //Volta com o tray icon original
    abfTrayIcon1.ImageList:=ImageList1;
    abfTrayIcon1.ImageIndex:=0;
    abfTrayIcon1.CycleIcons:=false;
end;

procedure TChatForm.FormCreate(Sender: TObject);
begin
  FileListenItemClick(nil);

  Memo1.ReadOnly:=true;
end;

procedure TChatForm.ServerSocketError(Sender: TObject; Number: Smallint;
  var Description: string; Scode: Integer; const Source, HelpFile: string;
  HelpContext: Integer; var CancelDisplay: Wordbool);
begin
  ShowMessage(Description);
end;

procedure TChatForm.Disconnect1Click(Sender: TObject);
begin
  ClickWav.Play;

  ClientSocket.Active := False;
  ServerSocket.Active := True;
  Statusbar1.Panels[0].Text := 'Desconectado';

  SpeedButton1.Enabled:=true;
  FileconnectItem.Enabled:=true;
  SpeedButton2.Enabled:=false;
  Disconnect1.Enabled:=false;
  Desconectar1.Enabled:=false;

  Memo1.ReadOnly:=true;

  //Volta com o tray icon original
  abfTrayIcon1.ImageList:=ImageList1;
  abfTrayIcon1.ImageIndex:=0;
  abfTrayIcon1.CycleIcons:=false;
end;

procedure TChatForm.ClientSocketConnect(Sender: TObject;
  Socket: TCustomWinSocket);
begin
  Statusbar1.Panels[0].Text := 'Conectado a: ' + Socket.RemoteHost;

  SpeedButton1.Enabled:=false;
  FileconnectItem.Enabled:=false;
  SpeedButton2.Enabled:=true;
  Disconnect1.Enabled:=true;
  Desconectar1.Enabled:=true;

  Memo1.ReadOnly:=false;

end;

procedure TChatForm.ClientSocketRead(Sender: TObject;
  Socket: TCustomWinSocket);
var
horario: string;
begin
  Memo2.Lines.Add(Socket.ReceiveText);

  horario:=timetostr(time);
  //Teste pra colocar ou tirar o alerta de Mensagem
  if not CheckBox1.Checked=true then
  begin
  MessageWav.Play;
  Panel2.Caption:='Última mensagem recebida as '+horario+'.';
  //Quando chega mensagem e pisca no tray icon
  abfTrayIcon1.ImageList:=ImageList2;
  abfTrayIcon1.CycleIcons:=true;
  end

  else
  begin
  Panel2.Caption:='Última mensagem recebida as '+horario+'.';
  //Quando chega mensagem e pisca no tray icon
  abfTrayIcon1.ImageList:=ImageList2;
  abfTrayIcon1.CycleIcons:=true;
  end;

end;

procedure TChatForm.ServerSocketClientRead(Sender: TObject;
  Socket: TCustomWinSocket);
var
horario: string;
begin
  Memo2.Lines.Add(Socket.ReceiveText);

  horario:=timetostr(time);
  //Teste pra colocar ou tirar o alerta de Mensagem
  if not CheckBox1.Checked=true then
  begin
  MessageWav.Play;
  Panel2.Caption:='Última mensagem recebida as '+horario+'.';
  //Quando chega mensagem e pisca no tray icon
  abfTrayIcon1.ImageList:=ImageList2;
  abfTrayIcon1.CycleIcons:=true;
  end

  else
  begin
  Panel2.Caption:='Última mensagem recebida as '+horario+'.';
  //Quando chega mensagem e pisca no tray icon
  abfTrayIcon1.ImageList:=ImageList2;
  abfTrayIcon1.CycleIcons:=true;
  end;

end;

procedure TChatForm.ServerSocketAccept(Sender: TObject;
  Socket: TCustomWinSocket);
begin
  IsServer := True;
  Statusbar1.Panels[0].Text := 'Conectado a: ' + Socket.RemoteAddress;

  SpeedButton1.Enabled:=false;
  FileconnectItem.Enabled:=false;
  SpeedButton2.Enabled:=true;
  Disconnect1.Enabled:=true;
  Desconectar1.Enabled:=true;

  Memo1.ReadOnly:=false;

end;

procedure TChatForm.ServerSocketClientConnect(Sender: TObject;
  Socket: TCustomWinSocket);
begin
  Memo2.Lines.Clear;
end;

procedure TChatForm.ClientSocketDisconnect(Sender: TObject;
  Socket: TCustomWinSocket);
begin
  FileListenItemClick(nil);
end;

procedure TChatForm.ClientSocketError(Sender: TObject;
  Socket: TCustomWinSocket; ErrorEvent: TErrorEvent;
  var ErrorCode: Integer);
begin
  Memo2.Lines.Add('Erro ao conectar com: ' + Server);
  ErrorCode := 0;

  ErrorWav.Play;

  Memo1.ReadOnly:=true;

end;

procedure TChatForm.ServerSocketClientDisconnect(Sender: TObject;
  Socket: TCustomWinSocket);
begin
  Statusbar1.Panels[0].Text := 'Desconectado';

  SpeedButton1.Enabled:=true;
  FileconnectItem.Enabled:=true;
  SpeedButton2.Enabled:=false;
  Disconnect1.Enabled:=false;
  Desconectar1.Enabled:=false;

  Memo1.ReadOnly:=true;

end;

procedure TChatForm.SpeedButton3Click(Sender: TObject);
begin
   ClickWav.Play;

   Memo1.Clear;
   Memo2.Clear;

   //Volta com o tray icon original
   abfTrayIcon1.ImageList:=ImageList1;
   abfTrayIcon1.ImageIndex:=0;
   abfTrayIcon1.CycleIcons:=false;
end;

procedure TChatForm.SpeedButton4Click(Sender: TObject);
begin
    ClickWav.Play;

    //Volta com o tray icon original
    abfTrayIcon1.ImageList:=ImageList1;
    abfTrayIcon1.ImageIndex:=0;
    abfTrayIcon1.CycleIcons:=false;

    if  fontDialog1.Execute then
    Memo1.Font:=FontDialog1.Font;
end;

procedure TChatForm.SpeedButton5Click(Sender: TObject);
begin
   ClickWav.Play;

   //Volta com o tray icon original
   abfTrayIcon1.ImageList:=ImageList1;
   abfTrayIcon1.ImageIndex:=0;
   abfTrayIcon1.CycleIcons:=false;

   if  ColorDialog1.Execute then
   Memo1.Color:=ColorDialog1.Color;
end;

procedure TChatForm.SpeedButton6Click(Sender: TObject);
begin
  ServerSocket.Close;
  ClientSocket.Close;
  Close;
end;

procedure TChatForm.SpeedButton2Click(Sender: TObject);
begin
  ClickWav.Play;

  ClientSocket.Active := False;
  ServerSocket.Active := True;
  Statusbar1.Panels[0].Text := 'Desconectado';

  SpeedButton1.Enabled:=true;
  FileconnectItem.Enabled:=true;
  SpeedButton2.Enabled:=false;
  Disconnect1.Enabled:=false;
  Desconectar1.Enabled:=false;

  Memo1.ReadOnly:=true;

  //Volta com o tray icon original
  abfTrayIcon1.ImageList:=ImageList1;
  abfTrayIcon1.ImageIndex:=0;
  abfTrayIcon1.CycleIcons:=false;
end;

procedure TChatForm.Memo1Click(Sender: TObject);
begin
  //Volta com o tray icon original
  abfTrayIcon1.ImageList:=ImageList1;
  abfTrayIcon1.ImageIndex:=0;
  abfTrayIcon1.CycleIcons:=false;
end;

procedure TChatForm.Memo2Click(Sender: TObject);
begin
  //Volta com o tray icon original
  abfTrayIcon1.ImageList:=ImageList1;
  abfTrayIcon1.ImageIndex:=0;
  abfTrayIcon1.CycleIcons:=false;
end;

procedure TChatForm.abfTrayIcon1DblClick(Sender: TObject);
begin
  //Volta com o tray icon original
  abfTrayIcon1.ImageList:=ImageList1;
  abfTrayIcon1.ImageIndex:=0;
  abfTrayIcon1.CycleIcons:=false;
end;

procedure TChatForm.Recortar1Click(Sender: TObject);
begin
Texto:=memo1.seltext;
Memo1.Seltext:=' ';
end;

procedure TChatForm.Copiar1Click(Sender: TObject);
begin
Texto:=memo1.seltext;
end;

procedure TChatForm.Colar1Click(Sender: TObject);
begin
Memo1.SelText:=Texto;
end;

procedure TChatForm.DefinirFonte1Click(Sender: TObject);
begin
    ClickWav.Play;

    //Volta com o tray icon original
    abfTrayIcon1.ImageList:=ImageList1;
    abfTrayIcon1.ImageIndex:=0;
    abfTrayIcon1.CycleIcons:=false;

    if  fontDialog1.Execute then
    Memo1.Font:=FontDialog1.Font;
end;

procedure TChatForm.DefinirFundo1Click(Sender: TObject);
begin
   ClickWav.Play;

   //Volta com o tray icon original
   abfTrayIcon1.ImageList:=ImageList1;
   abfTrayIcon1.ImageIndex:=0;
   abfTrayIcon1.CycleIcons:=false;

   if  ColorDialog1.Execute then
   Memo1.Color:=ColorDialog1.Color;
end;

procedure TChatForm.SelecionarTudo1Click(Sender: TObject);
begin
Memo1.Selectall;
end;

procedure TChatForm.ToolBar1Click(Sender: TObject);
begin
  //Volta com o tray icon original
  abfTrayIcon1.ImageList:=ImageList1;
  abfTrayIcon1.ImageIndex:=0;
  abfTrayIcon1.CycleIcons:=false;
end;

procedure TChatForm.ToolButton1Click(Sender: TObject);
begin
   ClickWav.Play;

   //Volta com o tray icon original
   abfTrayIcon1.ImageList:=ImageList1;
   abfTrayIcon1.ImageIndex:=0;
   abfTrayIcon1.CycleIcons:=false;

   if CheckBox1.Checked=true then
   begin
   CheckBox1.Checked:=false; //Com alerta de mensagem
   ToolButton1.ImageIndex:=0;
   end

   else
   begin
   CheckBox1.Checked:=true; //Sem alerta de mensagem
   ToolButton1.ImageIndex:=1;
   end;
end;

procedure TChatForm.Minimizar1Click(Sender: TObject);
begin
  abfTrayIcon1.HideMainForm; //Esconder a aplicação
end;

procedure TChatForm.Maximizar1Click(Sender: TObject);
begin
  abfTrayIcon1.ShowMainForm; //Aparecer com a aplicação

  //Volta com o tray icon original
  abfTrayIcon1.ImageList:=ImageList1;
  abfTrayIcon1.ImageIndex:=0;
  abfTrayIcon1.CycleIcons:=false;
end;

procedure TChatForm.Sair1Click(Sender: TObject);
begin
  ServerSocket.Close;
  ClientSocket.Close;
  Close;
end;

procedure TChatForm.Desconectar1Click(Sender: TObject);
begin
  ClickWav.Play;

  ClientSocket.Active := False;
  ServerSocket.Active := True;
  Statusbar1.Panels[0].Text := 'Desconectado';

  SpeedButton1.Enabled:=true;
  FileconnectItem.Enabled:=true;
  SpeedButton2.Enabled:=false;
  Disconnect1.Enabled:=false;
  Desconectar1.Enabled:=false;

  Memo1.ReadOnly:=true;

  //Volta com o tray icon original
  abfTrayIcon1.ImageList:=ImageList1;
  abfTrayIcon1.ImageIndex:=0;
  abfTrayIcon1.CycleIcons:=false;
end;

procedure TChatForm.Ajuda1Click(Sender: TObject);
begin
AboutBox.visible:=true;
ChatForm.Enabled:=false;
end;

end.
